name: ğŸš€ Auto Deploy ke STB

on:
  push:
    branches:
      - main
      - development

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Cek perubahan sebelum deploy
        run: |
          echo "=== STATUS GIT ==="
          git status
          echo "=== FILE YANG BERUBAH ==="
          git diff --name-only HEAD~1 HEAD || true
          echo "=== DETAIL PERUBAHAN ==="
          git diff HEAD~1 HEAD || true

      - name: ğŸ§° Install zip utility
        run: sudo apt-get install zip -y

      - name: ğŸ§¹ Hapus ZIP lama
        run: rm -f deploy.zip

      - name: ğŸ“ Buat ZIP (tanpa folder root)
        run: |
          zip -r deploy.zip * .[^.]* \
            -x ".git*" \
            -x ".github*" \
            -x "node_modules/*"

          echo "=== LIST ISI ZIP ==="
          unzip -l deploy.zip

      - name: ğŸš€ Upload ke STB Server
        id: deploy
        run: |
          echo "ğŸš€ Uploading ${{ github.repository }}..."

          RESPONSE=$(curl -s -S -k -H "Cache-Control: no-cache" -m 60 --connect-timeout 10 \
            -X POST \
            -F "repo=${{ github.event.repository.name }}" \
            -F "file=@deploy.zip" \
            "https://deploy.akhzafachrozy.my.id/")

          echo "=== RESPONSE SERVER ==="
          echo "$RESPONSE"
          
          PORT=$(echo "$RESPONSE" | grep -oP '(?<=Port:\s)\d+')
          if [ -z "$PORT" ]; then
            echo "âš ï¸ Port tidak terdeteksi!"
          else
            echo "ğŸŒ Aplikasi berjalan di port: $PORT"
            echo "port=$PORT" >> $GITHUB_OUTPUT
          fi

      - name: âœ… Selesai
        run: |
          echo "ğŸ‰ Deploy sukses!"
          echo "ğŸŒ Port aktif: ${{ steps.deploy.outputs.port }}"
